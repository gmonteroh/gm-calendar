<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GM Calendar</title>
  <meta name="description" content="Mini PWA para agendar eventos r√°pido en Outlook/Teams.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d4">

  <!-- iPhone -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    body { font-family: Arial; background: #f3f6fb; margin: 0; padding: 16px; }
    .card { max-width: 600px; margin: auto; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    textarea { width: 100%; height: 100px; margin-top: 10px; font-size: 16px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { padding: 12px; margin-top: 10px; width: 48%; border: none; border-radius: 8px; background: #0078d4; color: white; font-weight: bold; }
    .row { display: flex; justify-content: space-between; gap: 4%; }
    .result { background: #eef5ff; padding: 12px; margin-top: 10px; border-radius: 8px; display: none; }
  </style>
</head>

<body>
  <div class="card">
    <h2>GM Calendar</h2>
    <p>Escribe algo como: <b>"ma√±ana 15:00 reuni√≥n"</b> o <b>"28/11 9:30 proveedor"</b>.</p>

    <textarea id="input" placeholder="Escribe aqu√≠..."></textarea>

    <div class="row">
      <button id="dictBtn">üé§ Dictar</button>
      <button id="parseBtn">üîé Procesar</button>
    </div>

    <div class="row">
      <button id="outlookBtn">üìß Outlook</button>
      <button id="icsBtn">‚¨áÔ∏è .ics</button>
    </div>

    <div id="result" class="result"></div>
  </div>

<script>
/* ================================
   AQU√ç EST√Å TU JAVASCRIPT ORIGINAL
   ================================ */

function parseSpanishDate(text) {
  text = text.toLowerCase();

  const now = new Date();

  // Detect ‚Äúma√±ana 15:00‚Äù
  if (text.includes("ma√±ana")) {
    const match = text.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1,
        parseInt(match[1]), parseInt(match[2]));
      return tomorrow;
    }
  }

  // Detect ‚Äúhoy 14:30‚Äù
  if (text.includes("hoy")) {
    const match = text.match(/(\d{1,2}):(\d{2})/);
    if (match) {
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(),
        parseInt(match[1]), parseInt(match[2]));
      return today;
    }
  }

  // Detect ‚Äú26/11 9:30‚Äù
  const full = text.match(/(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2})/);
  if (full) {
    return new Date(now.getFullYear(), full[2] - 1, full[1],
      full[3], full[4]);
  }

  return null;
}

function formatICSDate(d) {
  return d.getFullYear().toString() +
    String(d.getMonth() + 1).padStart(2, "0") +
    String(d.getDate()).padStart(2, "0") + "T" +
    String(d.getHours()).padStart(2, "0") +
    String(d.getMinutes()).padStart(2, "0") +
    "00";
}

document.getElementById("parseBtn").onclick = () => {
  const txt = document.getElementById("input").value;
  const date = parseSpanishDate(txt);

  const box = document.getElementById("result");
  box.style.display = "block";

  if (!date) {
    box.innerHTML = "No pude interpretar la fecha.";
    return;
  }

  box.innerHTML = 
    "Fecha detectada: <b>" + date.toLocaleString() + "</b>";
};

document.getElementById("icsBtn").onclick = () => {
  const txt = document.getElementById("input").value;
  const date = parseSpanishDate(txt);

  if (!date) return alert("Sin fecha v√°lida.");

  const end = new Date(date.getTime() + 60 * 60 * 1000);
  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${formatICSDate(date)}
DTEND:${formatICSDate(end)}
SUMMARY:Evento
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], { type: "text/calendar" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "evento.ics";
  a.click();
};

document.getElementById("outlookBtn").onclick = () => {
  window.open("https://outlook.office.com/calendar/view/day");
};

document.getElementById("dictBtn").onclick = () => {
  alert("Dictado a√∫n no implementado en esta versi√≥n.");
};

</script>

<!-- Registrar Service Worker -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .catch(err => console.log("SW error:", err));
}
</script>

</body>
</html>
