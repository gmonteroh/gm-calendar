<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GM Calendar</title>
  <meta name="description" content="Mini PWA para agendar eventos por voz.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d4">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f6fb;
      margin: 0;
      padding: 16px;
    }
    .card {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 90px;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .result {
      background: #eef5ff;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      display: none;
    }
    #dict-float {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0078d4;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      display: none;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>GM Calendar</h2>
    <p>Habla algo como: <b>‚Äúma√±ana 930 reuni√≥n proveedor‚Äù</b></p>

    <textarea id="input" placeholder="Habla ahora‚Ä¶" readonly></textarea>

    <div id="result" class="result"></div>
  </div>

  <div id="dict-float">üé§ Dictando‚Ä¶ usa el micr√≥fono del teclado</div>

<script>
/* =============================
   PARSER FECHA / HORA / T√çTULO
   ============================= */

function parseTime(token) {
  if (!token) return { h: 9, m: 0 };

  token = token.replace(/\s+/g, "").toLowerCase();
  let pm = token.includes("pm");
  token = token.replace(/am|pm|h/g, "");

  if (token.includes(":")) {
    let [h, m] = token.split(":");
    h = parseInt(h); m = parseInt(m || "0");
    if (pm && h < 12) h += 12;
    return { h, m };
  }

  if (/^\d{3}$/.test(token))
    return { h: parseInt(token[0]), m: parseInt(token.slice(1)) };

  if (/^\d{4}$/.test(token))
    return { h: parseInt(token.slice(0,2)), m: parseInt(token.slice(2)) };

  if (/^\d{1,2}$/.test(token))
    return { h: parseInt(token), m: 0 };

  return { h: 9, m: 0 };
}

function extractTitle(text) {
  return text
    .replace(/\b(hoy|ma√±ana)\b/g, "")
    .replace(/\d{1,2}[:\s]?\d{0,2}/g, "")
    .replace(/\d{1,2}\/\d{1,2}/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .split(" ")
    .slice(0, 6)
    .join(" ") || "Evento";
}

function parseInput(text) {
  text = text.toLowerCase();
  const now = new Date();

  let date = new Date(now);
  if (text.includes("ma√±ana")) date.setDate(date.getDate() + 1);

  const dateMatch = text.match(/(\d{1,2})\/(\d{1,2})/);
  if (dateMatch) {
    date.setDate(parseInt(dateMatch[1]));
    date.setMonth(parseInt(dateMatch[2]) - 1);
  }

  const timeMatch = text.match(/(\d{1,2}[:\s]?\d{0,2}|\d{3,4})/);
  const { h, m } = parseTime(timeMatch ? timeMatch[0] : null);
  date.setHours(h, m, 0, 0);

  return {
    date,
    title: extractTitle(text)
  };
}

/* =============================
   INIT ‚Äì SOLO VOZ (iOS)
   ============================= */

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

window.addEventListener("load", () => {
  const textarea = document.getElementById("input");
  const float = document.getElementById("dict-float");
  const result = document.getElementById("result");

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if (!isIOS) {
    result.style.display = "block";
    result.innerHTML = "Esta app funciona con dictado por voz en iPhone.";
    return;
  }

  textarea.focus();
  float.style.display = "block";

  let last = "";
  let stable = 0;

  textarea.addEventListener("input", () => {
    const val = textarea.value.trim();
    if (!val) return;

    if (val === last) stable++;
    else stable = 0;

    last = val;

    if (stable >= 3) {
      float.style.display = "none";
      const parsed = parseInput(val);

      result.style.display = "block";
      result.innerHTML = `
        <strong>Evento:</strong> ${parsed.title}<br>
        <strong>Fecha:</strong> ${parsed.date.toLocaleString()}
      `;
    }
  });
});
</script>
</body>
</html>


