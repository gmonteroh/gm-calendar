<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GM Calendar</title>
  <meta name="description" content="Mini PWA para agendar eventos r√°pido en Outlook/Teams.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d4">

  <!-- iPhone -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    body { font-family: Arial; background: #f3f6fb; margin: 0; padding: 16px; }
    .card { max-width: 600px; margin: auto; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    textarea { width: 100%; height: 100px; margin-top: 10px; font-size: 16px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { padding: 12px; margin-top: 10px; width: 48%; border: none; border-radius: 8px; background: #0078d4; color: white; font-weight: bold; }
    .row { display: flex; justify-content: space-between; gap: 4%; }
    .result { background: #eef5ff; padding: 12px; margin-top: 10px; border-radius: 8px; display: none; }

    /* Mensaje flotante */
    #dict-float {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0078d4;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      display: none;
      z-index: 9999;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>GM Calendar</h2>
    <p>Escribe algo como: <b>"ma√±ana 15:00 reuni√≥n"</b> o <b>"28/11 9:30 proveedor"</b>.</p>

    <textarea id="input" placeholder="Escribe aqu√≠..."></textarea>

    <div class="row">
      <button id="dictBtn">üé§ Dictar</button>
      <button id="parseBtn">üîé Procesar</button>
    </div>

    <div class="row">
      <button id="outlookBtn">üìß Outlook</button>
      <button id="icsBtn">‚¨áÔ∏è .ics</button>
    </div>

    <div id="result" class="result"></div>
  </div>

  <div id="dict-float">Dictando‚Ä¶ toca el micr√≥fono del teclado</div>


<script>
/* --------------------------
   PARSER MEJORADO (FECHA/HORA/T√çTULO)
   -------------------------- */

function parseTimeToken(token) {
  if (!token) return { h: 9, m: 0, pm: false }; // default 09:00

  token = token.replace(/\s+/g, "").toLowerCase();

  // Quitar posible "h" final (ej "9h")
  token = token.replace(/h$/i, "");

  // AM/PM detect
  let pm = false;
  if (token.endsWith("pm")) { pm = true; token = token.replace(/pm$/i, ""); }
  if (token.endsWith("am")) { token = token.replace(/am$/i, ""); }

  // Si contiene ":"
  if (token.includes(":")) {
    const [hs, ms] = token.split(":");
    let h = parseInt(hs || "0");
    let m = parseInt(ms || "0");
    if (pm && h < 12) h += 12;
    if (!pm && h === 12) { /* 12am -> 0 handled only if explicitly am */ }
    return { h, m, pm };
  }

  // Si tipo "930" o "1530"
  if (/^\d{3,4}$/.test(token)) {
    if (token.length === 3) {
      const h = parseInt(token.charAt(0));
      const m = parseInt(token.slice(1));
      return { h, m, pm };
    } else {
      const h = parseInt(token.slice(0, 2));
      const m = parseInt(token.slice(2));
      return { h, m, pm };
    }
  }

  // Si solo hora "9" o "12"
  if (/^\d{1,2}$/.test(token)) {
    let h = parseInt(token);
    if (pm && h < 12) h += 12;
    return { h, m: 0, pm };
  }

  // Si no reconocemos, default
  return { h: 9, m: 0, pm };
}

function parseInputText(text) {
  const original = text || "";
  text = original.toLowerCase().trim();

  const now = new Date();

  // Patterns
  const datePattern = /(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?/; // dd/mm[/yyyy]
  const ma√±anaHoyPattern = /(ma√±ana|hoy)/;
  // time tokens could be like "9", "09:30", "930", "9 30", "9:30pm"
  const timePattern = /(\d{1,2}(?:[:\s]?\d{2})?(?:\s?(?:am|pm))?|\d{3,4}(?:am|pm)?)/i;

  // 1) Buscar fecha dd/mm (con posible hora)
  let matchDate = text.match(datePattern);
  if (matchDate) {
    const day = parseInt(matchDate[1], 10);
    const month = parseInt(matchDate[2], 10) - 1;
    let year = matchDate[3] ? parseInt(matchDate[3], 10) : now.getFullYear();
    if (year < 100) year += 2000; // 23 -> 2023

    // Buscar una hora cerca de la fecha (despu√©s de la fecha)
    const afterDateText = text.slice(matchDate.index + matchDate[0].length);
    const matchTime = afterDateText.match(timePattern);
    let timeToken = matchTime ? matchTime[0] : null;
    if (!timeToken) {
      // tambi√©n buscar tiempo antes de la fecha (ej "9:30 28/11")
      const beforeDateText = text.slice(0, matchDate.index);
      const matchTimeBefore = beforeDateText.match(timePattern);
      timeToken = matchTimeBefore ? matchTimeBefore[0] : null;
    }

    const { h, m } = parseTimeToken(timeToken ? timeToken.replace(/\s+/g, "") : null);
    const d = new Date(year, month, day, h, m);
    const title = extractTitleFromText(text, [matchDate[0], timeToken]);
    return { date: d, title };
  }

  // 2) Buscar "ma√±ana" o "hoy" con hora
  const matchHoyMan = text.match(/(ma√±ana|hoy)/);
  if (matchHoyMan) {
    const when = matchHoyMan[1]; // 'ma√±ana' o 'hoy'
    // Buscar hora tras la palabra
    const after = text.slice(matchHoyMan.index + when.length);
    let matchTime = after.match(timePattern);
    let timeToken = matchTime ? matchTime[0] : null;

    // si no hay hora despu√©s, buscar antes
    if (!timeToken) {
      const before = text.slice(0, matchHoyMan.index);
      const matchTimeBefore = before.match(timePattern);
      timeToken = matchTimeBefore ? matchTimeBefore[0] : null;
    }

    const { h, m } = parseTimeToken(timeToken ? timeToken.replace(/\s+/g, "") : null);

    const dayOffset = when === "ma√±ana" ? 1 : 0;
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + dayOffset, h, m);
    const title = extractTitleFromText(text, [when, timeToken]);
    return { date: d, title };
  }

  // 3) Buscar √∫nicamente hora (ej "9:30 reuni√≥n")
  const matchOnlyTime = text.match(timePattern);
  if (matchOnlyTime) {
    const timeToken = matchOnlyTime[0];
    const { h, m } = parseTimeToken(timeToken.replace(/\s+/g, ""));
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
    const title = extractTitleFromText(text, [timeToken]);
    return { date: d, title };
  }

  // No se pudo interpretar
  return { date: null, title: null };
}

function extractTitleFromText(text, tokensToRemove) {
  let t = text || "";
  tokensToRemove = tokensToRemove || [];
  // Normalizar
  t = t.toLowerCase();

  // Quitar tokens detectados (fechas, hoy, ma√±ana, horas)
  tokensToRemove.forEach(token => {
    if (!token) return;
    // escapar caracteres especiales para regex
    const esc = token.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
    t = t.replace(new RegExp(esc, "g"), " ");
  });

  // Quitar palabras comunes que no aportan t√≠tulo
  t = t.replace(/\b(hoy|ma√±ana|a las|a las|a las|am|pm|hrs|horas)\b/g, " ");

  // Quitar cualquier residual de formatos num√©ricos
  t = t.replace(/\d{1,2}[:\s]?\d{2}/g, " ");
  t = t.replace(/\d{1,2}\/\d{1,2}(?:\/\d{2,4})?/g, " ");

  // Limpiar espacios y acortar a 6 palabras
  t = t.replace(/\s+/g, " ").trim();
  if (!t) return "Evento";
  return t.split(" ").slice(0, 6).join(" ");
}

/* --------------------------
   ICS & UI HELPERS
   -------------------------- */

function formatICSDate(d) {
  // Formato local simplificado YYYYMMDDTHHMM00
  return (
    d.getFullYear().toString() +
    String(d.getMonth() + 1).padStart(2, "0") +
    String(d.getDate()).padStart(2, "0") + "T" +
    String(d.getHours()).padStart(2, "0") +
    String(d.getMinutes()).padStart(2, "0") +
    "00"
  );
}

/* --------------------------
   BOTONES: Procesar, ICS, Outlook
   -------------------------- */

document.getElementById("parseBtn").onclick = () => {
  const txt = document.getElementById("input").value;
  const parsed = parseInputText(txt);

  const box = document.getElementById("result");
  box.style.display = "block";

  if (!parsed.date) {
    box.innerHTML = "No pude interpretar la fecha/hora. Prueba con 'ma√±ana 9:30 reuni√≥n' o '28/11 9:30 proveedor'.";
    return;
  }

  box.innerHTML = `
    <strong>Fecha detectada:</strong> ${parsed.date.toLocaleString()}<br>
    <strong>T√≠tulo:</strong> ${parsed.title}
  `;
};

document.getElementById("icsBtn").onclick = () => {
  const txt = document.getElementById("input").value;
  const parsed = parseInputText(txt);

  if (!parsed.date) return alert("Sin fecha v√°lida. Intenta 'ma√±ana 930 reuni√≥n'.");

  const start = parsed.date;
  const end = new Date(start.getTime() + 60 * 60 * 1000);

  const safeTitle = parsed.title.replace(/[\r\n]+/g, " ").replace(/,/g, " ");
  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${formatICSDate(start)}
DTEND:${formatICSDate(end)}
SUMMARY:${safeTitle}
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], { type: "text/calendar" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "evento.ics";
  a.click();
};

document.getElementById("outlookBtn").onclick = () =>
  window.open("https://outlook.office.com/calendar/view/day");

/* --------------------------
   DICTADO iPhone (sin cambios)
   -------------------------- */
document.getElementById("dictBtn").onclick = () => {
  const textarea = document.getElementById("input");
  const float = document.getElementById("dict-float");

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  if (!isIOS) {
    alert("Dictado disponible solo en iPhone.");
    return;
  }

  textarea.focus();
  float.style.display = "block";

  textarea.addEventListener("input", () => {
    if (textarea.value.trim().length > 0) {
      float.style.display = "none";
    }
  });
};

/* --------------------------
   SERVICE WORKER (registrar)
   -------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .catch(err => console.log("SW error:", err));
}
</script>


