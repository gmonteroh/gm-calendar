<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GM Calendar</title>
<meta name="description" content="Mini PWA para crear eventos por voz">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078d4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">

<style>
  body { font-family: Arial,sans-serif; background:#f3f6fb; margin:0; padding:16px; }
  .card { max-width:600px; margin:auto; background:white; padding:16px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  textarea { width:100%; height:100px; font-size:18px; padding:12px; border-radius:8px; border:1px solid #ccc; }
  .result { background:#eef5ff; padding:12px; margin-top:12px; border-radius:8px; display:none; font-size:16px; }
  #tap-overlay { position:fixed; inset:0; background:#0078d4; color:white; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:bold; z-index:99999; text-align:center; padding:20px; }
  #dict-float { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0078d4; color:white; padding:12px 16px; border-radius:10px; font-size:15px; display:none; z-index:9999; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
  #action-btn { display:none; margin-top:12px; width:100%; padding:12px; border:none; border-radius:8px; background:#0078d4; color:white; font-size:18px; font-weight:bold; }
</style>
</head>

<body>

<div id="tap-overlay">
  Toca la pantalla para hablar üé§
</div>

<div class="card">
  <h2>GM Calendar</h2>
  <p>Habla naturalmente, por ejemplo:<br>
     <b>‚Äúma√±ana 930 reuni√≥n proveedor‚Äù</b></p>

  <textarea id="input" placeholder="Habla ahora‚Ä¶" readonly></textarea>
  <button id="action-btn">üìÖ Crear evento</button>
  <div id="result" class="result"></div>
</div>

<div id="dict-float">Dictando‚Ä¶ usa el micr√≥fono del teclado</div>

<script>
/* ===============================
   PARSER FECHA / HORA / T√çTULO
   =============================== */
function parseTime(token) {
  if(!token) return {h:9,m:0};
  token=token.replace(/\s+/g,"").toLowerCase();
  if(token.includes(":")){const [h,m]=token.split(":");return {h:parseInt(h),m:parseInt(m||0)}}
  if(/^\d{3}$/.test(token)){return {h:parseInt(token[0]),m:parseInt(token.slice(1))}}
  if(/^\d{4}$/.test(token)){return {h:parseInt(token.slice(0,2)),m:parseInt(token.slice(2))}}
  if(/^\d{1,2}$/.test(token)){return {h:parseInt(token),m:0}}
  return {h:9,m:0};
}

function parseInput(text){
  const now=new Date();
  text=text.toLowerCase();
  let dayOffset=0;if(text.includes("ma√±ana")) dayOffset=1;
  const dateMatch=text.match(/(\d{1,2})\/(\d{1,2})/);
  let day=now.getDate();let month=now.getMonth();let year=now.getFullYear();
  if(dateMatch){day=parseInt(dateMatch[1]);month=parseInt(dateMatch[2])-1;}
  const timeMatch=text.match(/\d{1,2}[:\s]?\d{0,2}/);
  const {h,m}=parseTime(timeMatch?timeMatch[0]:null);
  const date=new Date(year,month,day+dayOffset,h,m);
  let title=text.replace(/ma√±ana|hoy|\d{1,2}\/\d{1,2}|\d{1,2}[:\s]?\d{0,2}/g,"").replace(/\s+/g," ").trim();
  if(!title) title="Evento";
  return {date,title};
}

/* ===============================
   FORMATO ICS
   =============================== */
function formatICSDate(d){
  return d.getFullYear().toString()+
         String(d.getMonth()+1).padStart(2,"0")+
         String(d.getDate()).padStart(2,"0")+"T"+
         String(d.getHours()).padStart(2,"0")+
         String(d.getMinutes()).padStart(2,"0")+"00";
}

/* ===============================
   FLUJO SOLO VOZ
   =============================== */
const overlay=document.getElementById("tap-overlay");
const textarea=document.getElementById("input");
const float=document.getElementById("dict-float");
const box=document.getElementById("result");
const btn=document.getElementById("action-btn");

overlay.addEventListener("click",()=>{
  overlay.style.display="none";
  textarea.removeAttribute("readonly");

  setTimeout(()=>{textarea.focus({preventScroll:true});},100);
  float.style.display="block";

  // Observer para detectar dictado por voz
  const observer = new MutationObserver(()=>{
    const current=textarea.value.trim();
    if(!current) return;

    float.style.display="none";
    const parsed=parseInput(current);
    box.style.display="block";
    box.innerHTML=`<strong>Evento:</strong> ${parsed.title}<br>
                   <strong>Fecha:</strong> ${parsed.date.toLocaleString()}`;

    btn.style.display="block";
    btn.dataset.title=parsed.title;
    btn.dataset.date=parsed.date.toISOString();

    observer.disconnect(); // desconectar una vez usado
  });

  observer.observe(textarea, { characterData:true, childList:true, subtree:true });
});

/* ===============================
   BOT√ìN √öNICO: Crear evento (.ics + Outlook Web)
   =============================== */
btn.addEventListener("click",()=>{
  const title=btn.dataset.title;
  const start=new Date(btn.dataset.date);
  const end=new Date(start.getTime()+60*60*1000);

  // Crear ICS
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${formatICSDate(start)}
DTEND:${formatICSDate(end)}
SUMMARY:${title}
END:VEVENT
END:VCALENDAR`;
  const blob=new Blob([ics],{type:"text/calendar"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="evento.ics"; a.click();

  // Abrir Outlook Web
  const outlookUrl=`https://outlook.office.com/calendar/deeplink/compose?subject=${encodeURIComponent(title)}&startdt=${start.toISOString()}&enddt=${end.toISOString()}`;
  window.open(outlookUrl,"_blank");

  btn.style.display="none";
});

/* ===============================
   SERVICE WORKER
   =============================== */
if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}
</script>

</body>
</html>









